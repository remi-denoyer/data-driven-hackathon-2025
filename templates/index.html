<head>
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='styles.css') }}"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <header>
    <div class="logo-container">
      <img
        src="{{ url_for('static', filename='logo.png') }}"
        alt="Darwin Logo"
        class="logo"
      />
    </div>
    <form class="d-flex" method="get" action="/" onsubmit="showLoader(); return true;">
      <input
        class="form-control me-2"
        type="search"
        name="search"
        placeholder="Search"
        aria-label="Search"
        value="{{ search_term or '' }}"
      />
      <button class="btn btn-outline-success" type="submit">Search</button>
    </form>
  </header>
  <div class="container">
    <div class="sidebar">
      <div class="dropdown-section">
        <select id="metric-select" class="form-select" aria-label="Metric select">
          <option value="headcount" {% if current_metric == 'headcount' %}selected{% endif %}>
            Number of FTEs
          </option>
          <option value="funding_total" {% if current_metric == 'funding_total' %}selected{% endif %}>
            Total funding
          </option>
        </select>
      </div>
      <div class="section strengths">
        <h5>Strengths</h5>
        <ul>
          {% if selected_company_data and selected_company_data.positive_analysis %}
            <li>{{ selected_company_data.positive_analysis }}</li>
          {% else %}
            <li>No strengths data available for the selected company.</li>
          {% endif %}
        </ul>
      </div>

      <div class="section weaknesses">
        <h5>Weaknesses</h5>
        <ul>
          {% if selected_company_data and selected_company_data.negative_analysis %}
            <li>{{ selected_company_data.negative_analysis }}</li>
          {% else %}
            <li>No weaknesses data available for the selected company.</li>
          {% endif %}
        </ul>
      </div>

      <div class="section icebreakers">
        <h5>Icebreaker Questions</h5>
        <ul>
          {% if selected_company_data and selected_company_data.company_question %}
            <li>{{ selected_company_data.company_question }}</li>
          {% else %}
            <li>No icebreaker questions available for the selected company.</li>
          {% endif %}
        </ul>
      </div>
    </div>
    <div class="loader" id="loader" style="display: none;">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="plot-container" id="plot-container">{{ map_html|safe }}</div>
  </div>
  <script>
    document.getElementById("metric-select").addEventListener("change", function () {
      const metric = this.value;
      showLoader(); // Show the loader

      fetch(`/?metric=${metric}`, { method: "GET" })
        .then((response) => response.text())
        .then((html) => {
          // Parse the new HTML response and replace the plot container
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const newPlotContainer = doc.getElementById("plot-container");

          // Replace the existing plot container with the new one
          document.getElementById("plot-container").innerHTML = newPlotContainer.innerHTML;

          // Hide the loader after the update
          document.getElementById("loader").style.display = "none";
          document.getElementById("plot-container").classList.remove("hidden");
        })
        .catch((error) => {
          console.error("Error fetching updated data:", error);
          // Hide the loader in case of error
          document.getElementById("loader").style.display = "none";
        });
    });
    function showLoader() {
      document.getElementById("loader").style.display = "flex";
      document.getElementById("plot-container").classList.add("hidden");
    }
    // document.addEventListener("DOMContentLoaded", function () {
    const plotElement = document.querySelector(".plot-container");

    // Add click event listener to the treemap
    plotElement.addEventListener("plotly_treemapclick", function (event) {
      console.log("clicked on plot")
      const point = event.points[0];
      const company = point.label; // Get the selected company's name
      if (!company) return;

      // Update query parameters without reloading the page
      const url = new URL(window.location);
      url.searchParams.set("selected_company", company);
      window.history.replaceState({}, "", url);

      console.log(`Query parameter updated: selected_company=${company}`);

      // Optionally, make an API call or refresh data
      fetch(`/update_data?company=${encodeURIComponent(company)}`)
        .then(response => response.json())
        .then(data => {
          console.log("Updated data:", data);
          // Optionally update the UI dynamically
        })
        .catch(error => console.error("Error fetching updated data:", error));
    });
    // });
  </script>
</body>
