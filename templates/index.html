<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Treemap Example</title>
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='styles.css') }}"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <header>
    <div class="logo-container">
      <img
        src="{{ url_for('static', filename='logo.png') }}"
        alt="Darwin Logo"
        class="logo"
      />
    </div>
    <form class="d-flex" method="get" action="/" onsubmit="showLoader(); return true;">
      <input
        class="form-control me-2"
        type="search"
        name="search"
        placeholder="Search"
        aria-label="Search"
        value="{{ search_term or '' }}"
      />
      <button class="btn btn-outline-success" type="submit">Search</button>
    </form>
  </header>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="dropdown-section">
        <select
          id="metric-select"
          class="form-select"
          aria-label="Metric select"
        >
          <option value="headcount" {% if current_metric == 'headcount' %}selected{% endif %}>
            Number of FTEs
          </option>
          <option value="funding_total" {% if current_metric == 'funding_total' %}selected{% endif %}>
            Total funding
          </option>
        </select>
      </div>

      <div class="section strengths">
        <h5>Strengths</h5>
        <ul>
          {% if selected_company_data and selected_company_data.positive_analysis %}
            <li>{{ selected_company_data.positive_analysis }}</li>
          {% else %}
            <li>No strengths data available for the selected company.</li>
          {% endif %}
        </ul>
      </div>

      <div class="section weaknesses">
        <h5>Weaknesses</h5>
        <ul>
          {% if selected_company_data and selected_company_data.negative_analysis %}
            <li>{{ selected_company_data.negative_analysis }}</li>
          {% else %}
            <li>No weaknesses data available for the selected company.</li>
          {% endif %}
        </ul>
      </div>

      <div class="section icebreakers">
        <h5>Icebreaker Questions</h5>
        <ul>
          {% if selected_company_data and selected_company_data.company_question %}
            <li>{{ selected_company_data.company_question }}</li>
          {% else %}
            <li>No icebreaker questions available for the selected company.</li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Loader (with new animation) -->
    <div class="loader" id="loader" style="display: none;">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Plot Container -->
    <div class="plot-container" id="plot-container">
      {{ map_html|safe }}
    </div>
  </div>

  <script>
    // Show the loader, hide the treemap
    function showLoader() {
      document.getElementById("loader").style.display = "flex";
      document.getElementById("plot-container").classList.add("hidden");
    }

    // Hide the loader, show the treemap
    function hideLoader() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("plot-container").classList.remove("hidden");
    }

    // When metric changes, we don't fetch from the server anymore:
    // we just "instantly" update the client or console log.
    document.getElementById("metric-select").addEventListener("change", function () {
      const metric = this.value;
      showLoader();

      // If you want truly immediate local re-rendering,
      // you must have the data in JS and do a Plotly update.
      // For example:
      //
      //   updateTreemap(metric);  // Your custom function
      //
      // Here we simply simulate a quick update:
      setTimeout(() => {
        console.log(`Metric changed to: ${metric}, treemap updated instantly!`);
        hideLoader();
      }, 700); // simulate slight delay for the loader
    });

    // On treemap click, we call /update_data to load details for the side panel (optional).
    // This fetch is minimal and does NOT reload the page or re-fetch the main data.
    const plotElement = document.querySelector(".plot-container .js-plotly-plot");
    if (plotElement) {
      plotElement.on("plotly_treemapclick", function (event) {
        const point = event.points[0];
        const company = point.label;
        if (!company) return;

        // Update URL query param so we can identify selected company (without page reload)
        const url = new URL(window.location);
        url.searchParams.set("selected_company", company);
        window.history.replaceState({}, "", url);

        console.log(`Selected company: ${company}`);

        // Optionally call an endpoint to update side info
        fetch(`/update_data?company=${encodeURIComponent(company)}`)
          .then((response) => response.json())
          .then((data) => {
            console.log("Updated data from the server (partial fetch):", data);
            // If you want to update the side panel instantly, do it here
          })
          .catch((error) => console.error("Error fetching updated data:", error));
      });
    }
  </script>
</body>
</html>